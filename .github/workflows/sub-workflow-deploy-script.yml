name: "Internal: sub-workflow: deploy components and auth handover scripts for environment"

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
      artifact-id:
        required: true
        type: string
      branch:
        required: false
        type: string
        default: ""
    secrets:
      BLOB_STORAGE_CONNECTION_STRING:
        required: true

env:
  BUILD_ARTIFACT_NAME: build-artifact

permissions:
  contents: read

jobs:
  deploy-script:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - uses: benjlevesque/short-sha@v3.0
        id: short-sha

      - uses: actions/download-artifact@v5
        id: download
        with:
          artifact-ids: ${{ inputs.artifact-id }}

      - run: |
          # Copy preview app to the deployment folder
          mkdir -p ${{ steps.download.outputs.download-path }}/preview
          cp -r ./packages/cps-global-preview/* ${{ steps.download.outputs.download-path }}/preview/

          cp ./configuration/config.${{ inputs.environment }}.json ${{ steps.download.outputs.download-path }}/config.json
          if [ -f "./configuration/config.${{ inputs.environment }}.override.json" ]; then
            cp ./configuration/config.${{ inputs.environment }}.override.json ${{ steps.download.outputs.download-path }}/config.override.json
          fi

          # Read config values for the environment
          CONFIG_FILE="./configuration/config.${{ inputs.environment }}.json"
          COOKIE_HANDOVER_URL=$(jq -r '.COOKIE_HANDOVER_URL' "$CONFIG_FILE")
          TOKEN_HANDOVER_URL=$(jq -r '.TOKEN_HANDOVER_URL' "$CONFIG_FILE")

          # Prepend the window variables to the auth-handover.js file
          echo "window.cps_global_components_cookie_handover_url = '$COOKIE_HANDOVER_URL';" > ./prepared-auth-handover.js
          echo "window.cps_global_components_token_handover_url = '$TOKEN_HANDOVER_URL';" >> ./prepared-auth-handover.js
          cat "${{ steps.download.outputs.download-path }}/auth-handover.js" >> ./prepared-auth-handover.js
          mv -f ./prepared-auth-handover.js "${{ steps.download.outputs.download-path }}/auth-handover.js"

          # Create a copy of cps-global-components.js as global-components.js
          cp "${{ steps.download.outputs.download-path }}/cps-global-components.js" "${{ steps.download.outputs.download-path }}/global-components.js"
          cp "${{ steps.download.outputs.download-path }}/cps-global-components.js.map" "${{ steps.download.outputs.download-path }}/global-components.js.map"

          # If REDIRECT_SCRIPT_URL is set, replace cps-global-components.js with the redirect script
          REDIRECT_SCRIPT_URL=$(jq -r '.REDIRECT_SCRIPT_URL // empty' "$CONFIG_FILE")
          if [ -n "$REDIRECT_SCRIPT_URL" ]; then
            echo "REDIRECT_SCRIPT_URL is set to: $REDIRECT_SCRIPT_URL"
            echo "Replacing cps-global-components.js with redirect script..."
            sed "s|{{SCRIPT_URL}}|$REDIRECT_SCRIPT_URL|g" "${{ steps.download.outputs.download-path }}/script-redirect.js" > "${{ steps.download.outputs.download-path }}/cps-global-components.js"
            rm "${{ steps.download.outputs.download-path }}/cps-global-components.js.map"
          fi

          # Remove the redirect script template from deployment
          rm -f "${{ steps.download.outputs.download-path }}/script-redirect.js"

      - uses: azure/cli@v2.2.0 # pinned to minor version whilst MS fix https://github.com/azure/azure-cli/issues/32039
        with:
          azcliversion: latest
          inlineScript: |
            az storage container create \
              --name ${{ inputs.environment }} \
              --public-access container \
              --connection-string "${{ secrets.BLOB_STORAGE_CONNECTION_STRING }}"

            METADATA="buildsha=${{ steps.short-sha.outputs.sha }} buildrunid=${{ github.run_number }} buildtimestamp=\"${{ github.event.repository.updated_at }}\""
            if [ -n "${{ inputs.branch }}" ]; then
              METADATA="${METADATA} branch=\"${{ inputs.branch }}\""
            fi

            az storage blob upload-batch \
              --destination ${{ inputs.environment }} \
              --source "${{ steps.download.outputs.download-path }}" \
              --connection-string "${{ secrets.BLOB_STORAGE_CONNECTION_STRING }}" \
              --overwrite true \
              --content-cache-control "max-age=20, stale-while-revalidate=3600, stale-if-error=3600" \
              --metadata $METADATA
