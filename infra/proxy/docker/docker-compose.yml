# Base docker-compose - only main nginx config
# Use with overrides for additional layers:
#   docker-compose -f docker-compose.yml -f docker-compose.global-components.yml up
#   docker-compose -f docker-compose.yml -f docker-compose.global-components.yml -f docker-compose.vnext.yml up
#
# IMPORTANT: Run `pnpm build` before starting docker to populate dist/

services:
  nginx:
    build:
      context: ..
      dockerfile: docker/Dockerfile.base
    ports:
      - "8080:8080"
    environment:
      - NGINX_ENVSUBST_OUTPUT_DIR=/etc/nginx
      - WEBSITE_DNS_SERVER=127.0.0.11
      - AUTH_HANDOVER_WHITELIST=/auth-refresh-inbound,http://some-destination-domain.example.org
    volumes:
      # Mount from dist/ folder (built by pnpm build)
      - ../dist/nginx.conf.template:/etc/nginx/templates/nginx.conf.template:ro
      - ../dist/nginx.js:/etc/nginx/nginx.js:ro
    depends_on:
      - mock-upstream

  mock-upstream:
    build:
      context: .
      dockerfile: Dockerfile.mock
    ports:
      - "3000:3000"
