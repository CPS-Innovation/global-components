services:
  nginx:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    ports:
      - "8080:8080"
    environment:
      - NGINX_ENVSUBST_OUTPUT_DIR=/etc/nginx
      - WEBSITE_DNS_SERVER=127.0.0.11
    volumes:
      # Mount config files for live reload during development
      - ../config/global-components.conf.template:/etc/nginx/templates/global-components.conf.template:ro
      - ../config/global-components.js:/etc/nginx/templates/global-components.js:ro
      # Use test vars that point to mock-upstream
      - ./global-components-vars.mock.js:/etc/nginx/templates/global-components-vars.js:ro
    depends_on:
      - mock-upstream

  mock-upstream:
    build:
      context: .
      dockerfile: Dockerfile.mock
    ports:
      - "3000:3000"
