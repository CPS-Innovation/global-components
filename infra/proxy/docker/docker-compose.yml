# Base docker-compose - main nginx config with global-components
# Use with overrides for additional layers:
#   docker-compose -f docker-compose.yml -f docker-compose.vnext.yml up
#   docker-compose -f docker-compose.yml -f docker-compose.vnext.yml -f docker-compose.vnever.yml up
#
# IMPORTANT: Run `pnpm build` before starting docker to populate dist/

services:
  nginx:
    build:
      context: ..
      dockerfile: docker/Dockerfile.base
    ports:
      - "8080:8080"
    env_file:
      - global-components.mock.env
    environment:
      - NGINX_ENVSUBST_OUTPUT_DIR=/etc/nginx
      - WEBSITE_DNS_SERVER=127.0.0.11
      - AUTH_HANDOVER_WHITELIST=/auth-refresh-inbound,http://some-destination-domain.example.org
    volumes:
      # Mount directly from config/ (add .template suffix for nginx envsubst)
      - ../config/main/nginx.conf:/etc/nginx/templates/nginx.conf.template:ro
      - ../config/main/nginx.js:/etc/nginx/nginx.js:ro
      - ../config/main/global-components.conf:/etc/nginx/templates/global-components.conf.template:ro
      - ../dist/global-components.js:/etc/nginx/templates/global-components.js:ro
      - ./global-components-deployment.mock.json:/etc/nginx/global-components-deployment.json:ro
    depends_on:
      - mock-upstream

  mock-upstream:
    build:
      context: .
      dockerfile: Dockerfile.mock
    ports:
      - "3000:3000"
      - "3443:3443"
