js_import glocovnext from templates/global-components.vnext.js;

# Environment variables passed to njs
js_var $wm_mds_base_url ${WM_MDS_BASE_URL};
# Utility to let us know if we are healthy or not
location = /global-components/status {
  js_content glocovnext.handleStatus;
}

# Handle swagger for MDS specially to filter the body
location ~ ^/global-components/(.*swagger(\.json|/ui).*)$ {
  error_page 418 = @gloco_preflight;
  if ($request_method = OPTIONS) {
    return 418;
  }

  proxy_hide_header Access-Control-Allow-Origin;
  proxy_hide_header Access-Control-Allow-Credentials;

  add_header Access-Control-Allow-Origin $cors_origin always;
  add_header Access-Control-Allow-Credentials true always;

  proxy_set_header x-functions-key "${WM_MDS_ACCESS_KEY}";
  proxy_set_header Accept-Encoding "";  # Disable compression for body filter
  proxy_pass ${WM_MDS_BASE_URL}$1;

  js_body_filter glocovnext.filterSwaggerBody buffer_type=string;
}

# Data interaction with MDS - case summary and monitoring codes
# ^~ prefix match overrides the main config's regex /summary-only route
location ^~ /global-components/api/cases/ {
  location ~ ^/global-components/api/(cases/\d+/(summary|monitoring-codes))$ {
    error_page 418 = @gloco_preflight;
    if ($request_method = OPTIONS) {
      return 418;
    }

    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;

    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Credentials true always;

    js_header_filter glocovnext.logRequest;

    resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
    proxy_set_header Origin "https://${host}";
    proxy_set_header x-functions-key "${WM_MDS_ACCESS_KEY}";
    proxy_set_header cms-auth-values $cms_auth_values;
    proxy_set_header Authorization "";
    proxy_pass $wm_mds_base_url$1$is_args$args;
  }
  return 404;
}

# State management endpoint
location ~ ^/global-components/state/(.*)$ {
  error_page 418 = @gloco_preflight;
  if ($request_method = OPTIONS) {
    return 418;
  }
  add_header Access-Control-Allow-Origin $cors_origin always;
  add_header Access-Control-Allow-Credentials true always;

  resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
  js_fetch_verify off;

  js_content glocovnext.handleState;
}

location /global-components/analytics/ {
  error_page 418 = @gloco_preflight;
  if ($request_method = OPTIONS) {
    return 418;
  }

  proxy_hide_header Access-Control-Allow-Origin;
  proxy_hide_header Access-Control-Allow-Credentials;

  add_header Access-Control-Allow-Origin $cors_origin always;
  add_header Access-Control-Allow-Credentials true always;

  resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
  proxy_ssl_server_name on;
  proxy_pass https://uksouth-1.in.applicationinsights.azure.com/;
}

# --- Granular override for /moduleversioninfo ---
location ~ ^/cps-tst.outsystemsenterprise.com/(.*)/moduleversioninfo$ {
  resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
  # Forward with query string preserved
  proxy_pass https://cps-tst.outsystemsenterprise.com/$1/moduleversioninfo$is_args$args;

  # Headers
  proxy_set_header Host cps-tst.outsystemsenterprise.com;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-For $remote_addr;

  # WebSockets
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";

  proxy_ssl_server_name on;
  proxy_buffering off;

  # Cookies & redirects for sub-path
  proxy_cookie_path / /cps-tst.outsystemsenterprise.com/;
  proxy_redirect https://cps-tst.outsystemsenterprise.com/ /cps-tst.outsystemsenterprise.com/;

  # Rewrite root-relative URLs in HTML/JS
  sub_filter_once off;
  sub_filter_types text/html application/javascript text/javascript;
  sub_filter '="/' '="/cps-tst.outsystemsenterprise.com/';
  sub_filter "='/" "='/cps-tst.outsystemsenterprise.com/";
  sub_filter '("/' '("/cps-tst.outsystemsenterprise.com/';
}

# --- General reverse proxy for everything else under the sub-path ---
location /cps-tst.outsystemsenterprise.com/ {
  resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
  proxy_pass https://cps-tst.outsystemsenterprise.com/;

  # Headers
  proxy_set_header Host cps-tst.outsystemsenterprise.com;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-For $remote_addr;

  # WebSockets
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";

  proxy_ssl_server_name on;
  proxy_buffering off;

  # Cookies & redirects for sub-path
  proxy_cookie_path / /cps-tst.outsystemsenterprise.com/;
  proxy_redirect https://cps-tst.outsystemsenterprise.com/ /cps-tst.outsystemsenterprise.com/;

  # Rewrite root-relative URLs in HTML/JS
  sub_filter_once off;
  sub_filter_types text/html application/javascript text/javascript;
  sub_filter '="/' '="/cps-tst.outsystemsenterprise.com/';
  sub_filter "='/" "='/cps-tst.outsystemsenterprise.com/";
  sub_filter '("/' '("/cps-tst.outsystemsenterprise.com/';
}

# Allows other calls to validate Bearer token. Doesn't support
#  audience/scopes beyond standard MS ones
location = /global-components/validate-token {
    internal;
    resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
    js_fetch_verify off;
    js_content glocovnext.handleValidateToken;
}

    # Launch points for C button from CMS
    location = /launch/cms {
      return 302 https://${DEFAULT_UPSTREAM_CMS_DOMAIN_NAME}/polaris?r=https://cps.outsystemsenterprise.com/casework_blocks/home;
    }
    location = /launch/cin2 {
      return 302 https://cin2.cps.gov.uk/polaris?r=https%3A%2F%2Fcps-tst.outsystemsenterprise.com%2FCasework_Patterns%2Fauth-handover.html%3Fsrc%3Dhttps%3A%2F%2Fpolaris-qa-notprod.cps.gov.uk%2Fglobal-components%2Ftest%2Fauth-handover.js%26stage%3Dos-cookie-return%26r%3Dhttps%253A%252F%252Fcps-tst.outsystemsenterprise.com%252Fcasework_blocks%252Fhome%253FIsFromCMS%253DTrue;
    }
    location = /launch/cin3 {
      return 302 https://cin3.cps.gov.uk/polaris?r=https%3A%2F%2Fcps-tst.outsystemsenterprise.com%2FCasework_Patterns%2Fauth-handover.html%3Fsrc%3Dhttps%3A%2F%2Fpolaris-qa-notprod.cps.gov.uk%2Fglobal-components%2Ftest%2Fauth-handover.js%26stage%3Dos-cookie-return%26r%3Dhttps%253A%252F%252Fcps-tst.outsystemsenterprise.com%252Fcasework_blocks%252Fhome%253FIsFromCMS%253DTrue;
    }
    location = /launch/cin4 {
      return 302 https://cin4.cps.gov.uk/polaris?r=https%3A%2F%2Fcps-tst.outsystemsenterprise.com%2FCasework_Patterns%2Fauth-handover.html%3Fsrc%3Dhttps%3A%2F%2Fpolaris-qa-notprod.cps.gov.uk%2Fglobal-components%2Ftest%2Fauth-handover.js%26stage%3Dos-cookie-return%26r%3Dhttps%253A%252F%252Fcps-tst.outsystemsenterprise.com%252Fcasework_blocks%252Fhome%253FIsFromCMS%253DTrue;
    }
    location = /launch/cin5 {
      return 302 https://cin5.cps.gov.uk/polaris?r=https%3A%2F%2Fcps-tst.outsystemsenterprise.com%2FCasework_Patterns%2Fauth-handover.html%3Fsrc%3Dhttps%3A%2F%2Fpolaris-qa-notprod.cps.gov.uk%2Fglobal-components%2Ftest%2Fauth-handover.js%26stage%3Dos-cookie-return%26r%3Dhttps%253A%252F%252Fcps-tst.outsystemsenterprise.com%252Fcasework_blocks%252Fhome%253FIsFromCMS%253DTrue;
    }
    location = /launch/cms-proxy {
      return 302 https://polaris.cps.gov.uk/polaris?r=https://cps.outsystemsenterprise.com/casework_blocks/home;
    }
    location = /launch/cin2-proxy {
      return 302 https://polaris-qa-notprod.cps.gov.uk/polaris?r=https%3A%2F%2Fcps-tst.outsystemsenterprise.com%2FCasework_Patterns%2Fauth-handover.html%3Fsrc%3Dhttps%3A%2F%2Fpolaris-qa-notprod.cps.gov.uk%2Fglobal-components%2Ftest%2Fauth-handover.js%26stage%3Dos-cookie-return%26r%3Dhttps%253A%252F%252Fcps-tst.outsystemsenterprise.com%252Fcasework_blocks%252Fhome%253FIsFromCMS%253DTrue;
    }
    location = /launch/cin3-proxy {
      return 302 https://polaris-qa-notprod.cps.gov.uk/polaris?r=https%3A%2F%2Fcps-tst.outsystemsenterprise.com%2FCasework_Patterns%2Fauth-handover.html%3Fsrc%3Dhttps%3A%2F%2Fpolaris-qa-notprod.cps.gov.uk%2Fglobal-components%2Ftest%2Fauth-handover.js%26stage%3Dos-cookie-return%26r%3Dhttps%253A%252F%252Fcps-tst.outsystemsenterprise.com%252Fcasework_blocks%252Fhome%253FIsFromCMS%253DTrue;
    }
    location = /launch/cin4-proxy {
      return 302 https://polaris-qa-notprod.cps.gov.uk/polaris?r=https%3A%2F%2Fcps-tst.outsystemsenterprise.com%2FCasework_Patterns%2Fauth-handover.html%3Fsrc%3Dhttps%3A%2F%2Fpolaris-qa-notprod.cps.gov.uk%2Fglobal-components%2Ftest%2Fauth-handover.js%26stage%3Dos-cookie-return%26r%3Dhttps%253A%252F%252Fcps-tst.outsystemsenterprise.com%252Fcasework_blocks%252Fhome%253FIsFromCMS%253DTrue;
    }
    location = /launch/cin5-proxy {
      return 302 https://polaris-qa-notprod.cps.gov.uk/polaris?r=https%3A%2F%2Fcps-tst.outsystemsenterprise.com%2FCasework_Patterns%2Fauth-handover.html%3Fsrc%3Dhttps%3A%2F%2Fpolaris-qa-notprod.cps.gov.uk%2Fglobal-components%2Ftest%2Fauth-handover.js%26stage%3Dos-cookie-return%26r%3Dhttps%253A%252F%252Fcps-tst.outsystemsenterprise.com%252Fcasework_blocks%252Fhome%253FIsFromCMS%253DTrue;
    }