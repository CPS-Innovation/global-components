js_import glocovnext from templates/global-components.vnext.js;

# Environment variables passed to njs
js_var $global_components_application_id ${GLOBAL_COMPONENTS_APPLICATION_ID};
js_var $wm_mds_base_url ${WM_MDS_BASE_URL};

# Compute blob path suffix dynamically (adds /index.html for folder paths)
js_set $blob_index_suffix glocovnext.computeBlobIndexSuffix;

# Utility to let us know if we are healthy or not
location = /global-components/status {
  js_content glocovnext.handleStatus;
}

# Handle swagger for MDS specially to filter the body
location ~ ^/global-components/(.*swagger(\.json|/ui).*)$ {
  error_page 418 = @gloco_preflight;
  if ($request_method = OPTIONS) {
    return 418;
  }

  proxy_hide_header Access-Control-Allow-Origin;
  proxy_hide_header Access-Control-Allow-Credentials;

  add_header Access-Control-Allow-Origin $cors_origin always;
  add_header Access-Control-Allow-Credentials true always;

  proxy_set_header x-functions-key "${WM_MDS_ACCESS_KEY}";
  proxy_set_header Accept-Encoding "";  # Disable compression for body filter
  proxy_pass ${WM_MDS_BASE_URL}$1;

  js_body_filter glocovnext.filterSwaggerBody buffer_type=string;
}

# Redirect folder paths without trailing slash to canonical form (must be before the proxy location)
location ~ ^/global-components/(dev|test|prod)/[^.]*[^/]$ {
  return 301 $uri/;
}

# Proxy static assets from blob storage (dev/test/prod environments)
# e.g. /global-components/dev/cps-global-components.js -> blob storage
# Folder paths with trailing slash resolve to index.html inside that folder
location ~ ^/global-components/(dev|test|prod)/(.*)$ {
  error_page 418 = @gloco_preflight;
  if ($request_method = OPTIONS) {
    return 418;
  }

  proxy_hide_header Access-Control-Allow-Origin;
  proxy_hide_header Access-Control-Allow-Credentials;

  add_header Access-Control-Allow-Origin $cors_origin always;
  add_header Access-Control-Allow-Credentials true always;

  resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
  proxy_ssl_server_name on;
  proxy_pass_request_headers off;
  proxy_set_header Host sacpsglobalcomponents.blob.core.windows.net;
  proxy_pass ${GLOBAL_COMPONENTS_BLOB_STORAGE_URL}/$1/$2$blob_index_suffix;
}

# Data interaction with MDS - case summary and monitoring codes
# (vnext version - replaces main config's /summary-only route)
location ~ ^/global-components/api/(cases/\d+/(summary|monitoring-codes))$ {
  error_page 418 = @gloco_preflight;
  if ($request_method = OPTIONS) {
    return 418;
  }

  proxy_hide_header Access-Control-Allow-Origin;
  proxy_hide_header Access-Control-Allow-Credentials;

  add_header Access-Control-Allow-Origin $cors_origin always;
  add_header Access-Control-Allow-Credentials true always;

  resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
  proxy_set_header Origin "https://${host}";
  proxy_set_header x-functions-key "${WM_MDS_ACCESS_KEY}";
  proxy_set_header cms-auth-values $cms_auth_values;
  proxy_set_header Authorization "";
  proxy_pass $wm_mds_base_url$1$is_args$args;
}

# State management endpoint
# Auth is handled in njs: GET is public, PUT requires valid token
location ~ ^/global-components/state/(.*)$ {
  error_page 418 = @gloco_preflight;
  if ($request_method = OPTIONS) {
    return 418;
  }
  add_header Access-Control-Allow-Origin $cors_origin always;
  add_header Access-Control-Allow-Credentials true always;

  resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
  js_fetch_verify off;

  js_content glocovnext.handleState;
}

location /global-components/analytics/ {
  error_page 418 = @gloco_preflight;
  if ($request_method = OPTIONS) {
    return 418;
  }

  proxy_hide_header Access-Control-Allow-Origin;
  proxy_hide_header Access-Control-Allow-Credentials;

  add_header Access-Control-Allow-Origin $cors_origin always;
  add_header Access-Control-Allow-Credentials true always;

  resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
  proxy_ssl_server_name on;
  proxy_pass https://uksouth-1.in.applicationinsights.azure.com/;
}

# --- Granular override for /moduleversioninfo ---
location ~ ^/cps-tst.outsystemsenterprise.com/(.*)/moduleversioninfo$ {
  resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
  # Forward with query string preserved
  proxy_pass https://cps-tst.outsystemsenterprise.com/$1/moduleversioninfo$is_args$args;

  # Headers
  proxy_set_header Host cps-tst.outsystemsenterprise.com;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-For $remote_addr;

  # WebSockets
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";

  proxy_ssl_server_name on;
  proxy_buffering off;

  # Cookies & redirects for sub-path
  proxy_cookie_path / /cps-tst.outsystemsenterprise.com/;
  proxy_redirect https://cps-tst.outsystemsenterprise.com/ /cps-tst.outsystemsenterprise.com/;

  # Rewrite root-relative URLs in HTML/JS
  sub_filter_once off;
  sub_filter_types text/html application/javascript text/javascript;
  sub_filter '="/' '="/cps-tst.outsystemsenterprise.com/';
  sub_filter "='/" "='/cps-tst.outsystemsenterprise.com/";
  sub_filter '("/' '("/cps-tst.outsystemsenterprise.com/';
}

# --- General reverse proxy for everything else under the sub-path ---
location /cps-tst.outsystemsenterprise.com/ {
  resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
  proxy_pass https://cps-tst.outsystemsenterprise.com/;

  # Headers
  proxy_set_header Host cps-tst.outsystemsenterprise.com;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header X-Forwarded-For $remote_addr;

  # WebSockets
  proxy_http_version 1.1;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection "upgrade";

  proxy_ssl_server_name on;
  proxy_buffering off;

  # Cookies & redirects for sub-path
  proxy_cookie_path / /cps-tst.outsystemsenterprise.com/;
  proxy_redirect https://cps-tst.outsystemsenterprise.com/ /cps-tst.outsystemsenterprise.com/;

  # Rewrite root-relative URLs in HTML/JS
  sub_filter_once off;
  sub_filter_types text/html application/javascript text/javascript;
  sub_filter '="/' '="/cps-tst.outsystemsenterprise.com/';
  sub_filter "='/" "='/cps-tst.outsystemsenterprise.com/";
  sub_filter '("/' '("/cps-tst.outsystemsenterprise.com/';
}

# Allows other calls to validate Bearer token. Doesn't support
#  audience/scopes beyond standard MS ones
location = /global-components/validate-token {
    internal;
    resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
    js_fetch_verify off;
    js_content glocovnext.handleValidateToken;
}
