js_import glocospike from templates/global-components.spike.js;

# Spike env vars passed to njs
js_var $spike_tenant_id ${SPIKE_TENANT_ID};
js_var $spike_client_id ${SPIKE_CLIENT_ID};
js_var $spike_client_secret ${SPIKE_CLIENT_SECRET};
js_var $spike_redirect_uri ${SPIKE_REDIRECT_URI};
js_var $spike_storage_account ${SPIKE_STORAGE_ACCOUNT};
js_var $spike_storage_key ${SPIKE_STORAGE_KEY};

# Increment 2: MSAL.js test page (served as static file)
location = /spike/ {
    root /etc/nginx/static;
    rewrite ^ /spike.html break;
}

# Increment 1: OIDC login redirect
location = /spike/login {
    js_content glocospike.handleLogin;
}

# Increment 1: OIDC callback
location = /spike/callback {
    resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
    js_fetch_verify off;
    js_content glocospike.handleCallback;
}

# Increment 2: Token validation (Bearer token from App B)
location = /spike/validate {
    js_content glocospike.handleValidate;
}

# Increment 3: Store value in extension property (Bearer token + POST)
location = /spike/store {
    resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
    js_fetch_verify off;
    js_content glocospike.handleStore;
}

# Increment 4: Read extension property (Bearer token)
location = /spike/read {
    resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
    js_fetch_verify off;
    js_content glocospike.handleRead;
}

# Increment 5: Store value in Table Storage (Bearer token + POST)
location = /spike/table/store {
    resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
    js_fetch_verify off;
    js_content glocospike.handleTableStore;
}

# Increment 5: Read from Table Storage (Bearer token)
location = /spike/table/read {
    resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
    js_fetch_verify off;
    js_content glocospike.handleTableRead;
}

# Increment 6: Store compressed value in extension property (Bearer token + POST)
location = /spike/ext-compress/store {
    resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
    js_fetch_verify off;
    js_content glocospike.handleExtCompressStore;
}

# Increment 6: Read and decompress from extension property (Bearer token)
location = /spike/ext-compress/read {
    resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
    js_fetch_verify off;
    js_content glocospike.handleExtCompressRead;
}
