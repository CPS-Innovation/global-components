js_import glocospike from templates/global-components.spike.js;

# Spike env vars passed to njs
js_var $spike_tenant_id ${SPIKE_TENANT_ID};
js_var $spike_client_id ${SPIKE_CLIENT_ID};
js_var $spike_client_secret ${SPIKE_CLIENT_SECRET};
js_var $spike_redirect_uri ${SPIKE_REDIRECT_URI};
js_var $spike_store_redirect_uri ${SPIKE_STORE_REDIRECT_URI};
js_var $spike_table_store_redirect_uri ${SPIKE_TABLE_STORE_REDIRECT_URI};
js_var $spike_storage_account ${SPIKE_STORAGE_ACCOUNT};
js_var $spike_storage_key ${SPIKE_STORAGE_KEY};

# Increment 2: MSAL.js test page (served as static file)
location = /spike/ {
    root /etc/nginx/static;
    rewrite ^ /spike.html break;
}

# Increment 1: OIDC login redirect
location = /spike/login {
    js_content glocospike.handleLogin;
}

# Increment 1: OIDC callback
location = /spike/callback {
    resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
    js_fetch_verify off;
    js_content glocospike.handleCallback;
}

# Increment 2: Token validation (Bearer token from App B)
location = /spike/validate {
    js_content glocospike.handleValidate;
}

# Increment 3: Store value via OIDC redirect
location = /spike/store {
    js_content glocospike.handleStore;
}

# Increment 3: Store callback (exchange code, write extension)
location = /spike/store/callback {
    resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
    js_fetch_verify off;
    js_content glocospike.handleStoreCallback;
}

# Increment 4: Read extension property (validated via App B Bearer token)
location = /spike/read {
    resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
    js_fetch_verify off;
    js_content glocospike.handleRead;
}

# Increment 5: Store value via Table Storage (OIDC redirect)
location = /spike/table/store {
    js_content glocospike.handleTableStore;
}

# Increment 5: Table Storage store callback (exchange code, write to table)
location = /spike/table/store/callback {
    resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
    js_fetch_verify off;
    js_content glocospike.handleTableStoreCallback;
}

# Increment 5: Read from Table Storage (validated via App B Bearer token)
location = /spike/table/read {
    resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
    js_fetch_verify off;
    js_content glocospike.handleTableRead;
}
