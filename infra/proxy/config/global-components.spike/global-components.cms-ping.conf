# CMS Login Ping
#
# Intercepts the CMS login page POST response and injects a tracking pixel
# that notifies /polaris when a user has successfully logged in (with fresh
# .CMSAUTH cookies). The sub_filter target string only appears in the
# successful POST response, not in the GET login form.
#
# Uses an exact-match location so it takes priority over the catch-all
# regex ^/CMS.* regardless of include order (exact > regex in nginx).
# Depends on: cmsenv.js, $ieaction, cms_log format, cmsproxy rate limit zone.

location = /CMS.24.0.01/User/uaulLogin.aspx {
    client_max_body_size 0;
    access_log  /dev/stdout cms_log;
    limit_req zone=cmsproxy burst=${CMS_RATE_LIMIT_QUEUE};
    add_header 'x-limit-req-status' $limit_req_status always;

    # IE Mode Desired
    if ( $ieaction = 'nonie+nonconfigurable+') {
      return 402 'requires Internet Explorer mode';
    }
    if ( $ieaction = 'nonie+configurable+') {
      add_header X-InternetExplorerMode 1;
      return 302 "${WEBSITE_SCHEME}://${host}${request_uri}";
    }

    # Determine proxy location and CMS domain
    js_set $proxyDestination cmsenv.proxyDestinationCorsham;
    js_set $upstreamCmsDomainName cmsenv.upstreamCmsDomainName;
    js_set $upstreamCmsModernDomainName cmsenv.upstreamCmsModernDomainName;
    js_set $upstreamCmsServicesDomainName cmsenv.upstreamCmsServicesDomainName;

    sub_filter_types *;
    sub_filter_once off;
    sub_filter https:// ${WEBSITE_SCHEME}://;
    sub_filter '</html>' '<!-- General rule applied --></html>';

    sub_filter $upstreamCmsModernDomainName $host;
    sub_filter $upstreamCmsServicesDomainName $host;
    sub_filter $upstreamCmsDomainName $host;

    # Login ping: inject a tracking pixel after the redirect script.
    # The target string only exists in the successful login POST response
    # (not the GET login form), so this naturally fires only on login.
    sub_filter 'location.href = sNewHref;</script>' 'location.href = sNewHref;</script><img src="/polaris?ping" width="1" height="1" style="display:none">';

    # Disable gzip so sub_filter can inspect the body
    proxy_set_header Accept-Encoding "";

    proxy_redirect ~^(http|https)://[^/]+(/.*)?$ ${WEBSITE_SCHEME}://$host$2;
    proxy_ssl_server_name on;
    proxy_ssl_session_reuse off;
    proxy_ssl_verify off;

    proxy_set_header Host $upstreamCmsDomainName:443;
    proxy_set_header X-Forwarded-For $remote_addr;

    proxy_pass $proxyDestination;
}
