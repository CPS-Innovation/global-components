# CMS Login Ping
#
# Intercepts the CMS login page POST response and injects a tracking pixel
# that notifies /polaris-2 when a user has successfully logged in (with fresh
# .CMSAUTH cookies). The sub_filter target string only appears in the
# successful POST response, not in the GET login form.
#
# Uses an exact-match location so it takes priority over the catch-all
# regex ^/CMS.* regardless of include order (exact > regex in nginx).
# Depends on: cmsenv.js, $ieaction, cms_log format, cmsproxy rate limit zone.
#
# /polaris-2 and /init-2 are IE-mode-safe clones of /polaris and /init.
# The login ping img fires from IE mode context so the redirect chain
# must not block on $ieaction checks.

js_import cmsPing from templates/global-components.cms-ping.js;

location = /CMS.24.0.01/User/uaulLogin.aspx {
    client_max_body_size 0;
    access_log  /dev/stdout cms_log;
    limit_req zone=cmsproxy burst=${CMS_RATE_LIMIT_QUEUE};
    add_header 'x-limit-req-status' $limit_req_status always;

    # IE Mode Desired
    if ( $ieaction = 'nonie+nonconfigurable+') {
      return 402 'requires Internet Explorer mode';
    }
    if ( $ieaction = 'nonie+configurable+') {
      add_header X-InternetExplorerMode 1;
      return 302 "${WEBSITE_SCHEME}://${host}${request_uri}";
    }

    # Determine proxy location and CMS domain
    js_set $proxyDestination cmsenv.proxyDestinationCorsham;
    js_set $upstreamCmsDomainName cmsenv.upstreamCmsDomainName;
    js_set $upstreamCmsModernDomainName cmsenv.upstreamCmsModernDomainName;
    js_set $upstreamCmsServicesDomainName cmsenv.upstreamCmsServicesDomainName;

    sub_filter_types *;
    sub_filter_once off;
    sub_filter https:// ${WEBSITE_SCHEME}://;
    sub_filter '</html>' '<!-- General rule applied --></html>';

    sub_filter $upstreamCmsModernDomainName $host;
    sub_filter $upstreamCmsServicesDomainName $host;
    sub_filter $upstreamCmsDomainName $host;

    # Login ping: inject a hidden iframe on the top frameset that fires the
    # /polaris-2 cookie-capture chain. Appended to top.document.documentElement
    # so it survives the login frame navigating away. No delay needed.
    sub_filter 'location.href = sNewHref;</script>' 'try{var _f=top.document.createElement("iframe");_f.src="/polaris-2?polaris-ui-url=/global-components/cms-auth/login%3Fr%3Dhttps%3A%2F%2Fexample.com%2Flanding%26cc%3Dtest-cookie-value-5";_f.style.display="none";_f.onload=function(){_f.parentNode.removeChild(_f);};top.document.documentElement.appendChild(_f);}catch(e){} location.href = sNewHref;</script>';

    # Disable gzip so sub_filter can inspect the body
    proxy_set_header Accept-Encoding "";

    proxy_redirect ~^(http|https)://[^/]+(/.*)?$ ${WEBSITE_SCHEME}://$host$2;
    proxy_ssl_server_name on;
    proxy_ssl_session_reuse off;
    proxy_ssl_verify off;

    proxy_set_header Host $upstreamCmsDomainName:443;
    proxy_set_header X-Forwarded-For $remote_addr;

    proxy_pass $proxyDestination;
}

# IE-mode-safe clone of /polaris — captures cookies, redirects to /init-2
location /polaris-2 {

    if ( $ieaction = 'nonie+configurable+') {
      add_header X-InternetExplorerMode 1;
      return 302 "${WEBSITE_SCHEME}://${host}${request_uri}";
    }

    js_var $redirectHostAddress ${ENDPOINT_HTTP_PROTOCOL}://$host;
    js_content cmsPing.polarisAuthRedirect2;
}

# IE-mode-safe clone of /init — validates redirect, appends cc param
location /init-2 {
       # Edge Mode Desired:
     if ( $ieaction = 'ie+nonconfigurable+') {
       return 402 'requires non-internet explorer mode';
     }
     if ( $ieaction = 'ie+configurable+') {
       add_header X-InternetExplorerMode 0;
       return 302 "${WEBSITE_SCHEME}://${host}${request_uri}";
     }
     
    js_content cmsPing.appAuthRedirect2;
}
