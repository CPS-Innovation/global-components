# CMS Auth V2
#
# Self-contained OIDC round-trip: /polaris-v2 -> /init-v2/ -> AD -> /init-v2/callback
# First pass ends on a diagnostic HTML page.

js_import cmsauthv2 from templates/global-components.cms-auth-v2.js;

# Login page interception â€” inject iframe that fires /polaris-v2 cookie-capture
# chain on successful CMS login. Exact-match takes priority over the catch-all
# regex ^/CMS.* regardless of include order.
location = /CMS.24.0.01/User/uaulLogin.aspx {
    client_max_body_size 0;
    access_log  /dev/stdout cms_log;
    limit_req zone=cmsproxy burst=${CMS_RATE_LIMIT_QUEUE};
    add_header 'x-limit-req-status' $limit_req_status always;

    # IE Mode Desired
    if ( $ieaction = 'nonie+nonconfigurable+') {
      return 402 'requires Internet Explorer mode';
    }
    if ( $ieaction = 'nonie+configurable+') {
      add_header X-InternetExplorerMode 1;
      return 302 "${WEBSITE_SCHEME}://${host}${request_uri}";
    }

    # Determine proxy location and CMS domain
    js_set $proxyDestination cmsenv.proxyDestinationCorsham;
    js_set $upstreamCmsDomainName cmsenv.upstreamCmsDomainName;
    js_set $upstreamCmsModernDomainName cmsenv.upstreamCmsModernDomainName;
    js_set $upstreamCmsServicesDomainName cmsenv.upstreamCmsServicesDomainName;

    sub_filter_types *;
    sub_filter_once off;
    sub_filter https:// ${WEBSITE_SCHEME}://;
    sub_filter '</html>' '<!-- General rule applied --></html>';

    sub_filter $upstreamCmsModernDomainName $host;
    sub_filter $upstreamCmsServicesDomainName $host;
    sub_filter $upstreamCmsDomainName $host;

    # Login ping: inject a hidden iframe on the top frameset that fires the
    # /polaris-v2 cookie-capture chain. Appended to top.document.documentElement
    # so it survives the login frame navigating away. No delay needed.
    sub_filter 'location.href = sNewHref;</script>' 'try{var _f=top.document.createElement("iframe");_f.src="/polaris-v2";_f.style.display="none";_f.onload=function(){_f.parentNode.removeChild(_f);};top.document.documentElement.appendChild(_f);}catch(e){} location.href = sNewHref;</script>';

    # Disable gzip so sub_filter can inspect the body
    proxy_set_header Accept-Encoding "";

    proxy_redirect ~^(http|https)://[^/]+(/.*)?$ ${WEBSITE_SCHEME}://$host$2;
    proxy_ssl_server_name on;
    proxy_ssl_session_reuse off;
    proxy_ssl_verify off;

    proxy_set_header Host $upstreamCmsDomainName:443;
    proxy_set_header X-Forwarded-For $remote_addr;

    proxy_pass $proxyDestination;
}

location /polaris-v2 {
    js_content cmsauthv2.handlePolarisV2;
}

location = /init-v2/ {
    resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
    js_fetch_verify off;
    js_content cmsauthv2.handleInitV2;
}

location = /init-v2/callback {
    resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
    js_fetch_verify off;
    js_content cmsauthv2.handleInitV2Callback;
}

location = /init-v2/error {
    js_content cmsauthv2.handleInitV2Error;
}

location = /global-components/cms-modern-token-v2 {
    resolver ${WEBSITE_DNS_SERVER} ipv6=off valid=30s;
    js_fetch_verify off;
    js_content cmsauthv2.handleCmsModernToken;
}
