# CMS Session Persistence Proxy
#
# Serves CMS at /_CMS... alongside the existing /CMS... routes.
# Intercepts the login page GET to prevent .CMSAUTH cookie destruction,
# so users can return to an existing session without re-entering credentials.
#
# Include this file inside the main server block (port 80) where cmsenv.js
# is available and $ieaction is already set.

js_import cmsproxy from templates/global-components.cms-proxy-no-logout.js;

# ---------------------------------------------------------------------------
# Login page intercept — njs checks for .CMSAUTH cookie
# ---------------------------------------------------------------------------

location = /_CMS.24.0.01/User/uaulLogin.aspx {
    js_content cmsproxy.handleCmsLoginIntercept;
}

# Named location: proxy the real login page (used by njs internalRedirect
# when no .CMSAUTH cookie exists and the user needs the actual login form)
location @cms_login_upstream {
    access_log  /dev/stdout cms_log;
    limit_req zone=cmsproxy burst=${CMS_RATE_LIMIT_QUEUE};
    add_header 'x-limit-req-status' $limit_req_status always;

    # IE Mode Desired
    if ( $ieaction = 'nonie+nonconfigurable+') {
      return 402 'requires Internet Explorer mode';
    }
    if ( $ieaction = 'nonie+configurable+') {
      add_header X-InternetExplorerMode 1;
      return 302 "${WEBSITE_SCHEME}://${host}${request_uri}";
    }

    # Determine proxy location and CMS domain
    js_set $proxyDestination cmsenv.proxyDestinationCorsham;
    js_set $upstreamCmsDomainName cmsenv.upstreamCmsDomainName;
    js_set $upstreamCmsModernDomainName cmsenv.upstreamCmsModernDomainName;
    js_set $upstreamCmsServicesDomainName cmsenv.upstreamCmsServicesDomainName;

    # Rewrite upstream domain names to proxy host
    sub_filter_types *;
    sub_filter_once off;
    sub_filter https:// ${WEBSITE_SCHEME}://;
    sub_filter $upstreamCmsModernDomainName $host;
    sub_filter $upstreamCmsServicesDomainName $host;
    sub_filter $upstreamCmsDomainName $host;

    # Rewrite internal CMS paths to the /_CMS prefix
    sub_filter '/CMS.24.0.01/' '/_CMS.24.0.01/';

    # Disable gzip so sub_filter can inspect the body
    proxy_set_header Accept-Encoding "";

    # Rewrite Set-Cookie paths from /CMS to /_CMS
    proxy_cookie_path /CMS /_CMS;

    proxy_redirect ~^(http|https)://[^/]+(/.*)?$ ${WEBSITE_SCHEME}://$host$2;
    proxy_ssl_server_name on;
    proxy_ssl_session_reuse off;
    proxy_ssl_verify off;

    proxy_set_header Host $upstreamCmsDomainName:443;
    proxy_set_header X-Forwarded-For $remote_addr;

    proxy_pass $proxyDestination/CMS.24.0.01/User/uaulLogin.aspx$is_args$args;
}

# ---------------------------------------------------------------------------
# uainGeneratedScript — c-button replacement
# Mirrors: location ~ ^/CMS\..*/Includes/uainGeneratedScript.aspx
# ---------------------------------------------------------------------------

location = /_CMS.24.0.01/Includes/uainGeneratedScript.aspx {
    access_log  /dev/stdout cms_log;
    limit_req zone=cmsproxy burst=${CMS_RATE_LIMIT_QUEUE};
    add_header 'x-limit-req-status' $limit_req_status always;

    # Determine proxy location and CMS domain
    js_set $proxyDestination cmsenv.proxyDestinationCorsham;
    js_set $upstreamCmsDomainName cmsenv.upstreamCmsDomainName;
    js_set $upstreamCmsModernDomainName cmsenv.upstreamCmsModernDomainName;
    js_set $upstreamCmsServicesDomainName cmsenv.upstreamCmsServicesDomainName;

    sub_filter_types *;
    sub_filter_once off;
    sub_filter https:// ${WEBSITE_SCHEME}://;

    sub_filter $upstreamCmsModernDomainName $host;
    sub_filter $upstreamCmsServicesDomainName $host;
    sub_filter $upstreamCmsDomainName $host;

    # Replace the c-button to support proxied CMS
    sub_filter 'var CASEWORK_TOOLS_URL = \'https://polaris.cps.gov.uk/launch/cms\';' 'var CASEWORK_TOOLS_URL = \'https://polaris.cps.gov.uk/launch/cms-proxy\';';
    sub_filter 'var CASEWORK_TOOLS_URL = \'https://polaris-qa-notprod.cps.gov.uk/launch/cin2\';' 'var CASEWORK_TOOLS_URL = \'https://polaris-qa-notprod.cps.gov.uk/launch/cin2-proxy\';';
    sub_filter 'var CASEWORK_TOOLS_URL = \'https://polaris-qa-notprod.cps.gov.uk/launch/cin3\';' 'var CASEWORK_TOOLS_URL = \'https://polaris-qa-notprod.cps.gov.uk/launch/cin3-proxy\';';
    sub_filter 'var CASEWORK_TOOLS_URL = \'https://polaris-qa-notprod.cps.gov.uk/launch/cin4\';' 'var CASEWORK_TOOLS_URL = \'https://polaris-qa-notprod.cps.gov.uk/launch/cin4-proxy\';';
    sub_filter 'var CASEWORK_TOOLS_URL = \'https://polaris-qa-notprod.cps.gov.uk/launch/cin5\';' 'var CASEWORK_TOOLS_URL = \'https://polaris-qa-notprod.cps.gov.uk/launch/cin5-proxy\';';

    # Rewrite internal CMS paths to the /_CMS prefix
    sub_filter '/CMS.24.0.01/' '/_CMS.24.0.01/';

    # Disable gzip so sub_filter can inspect the body
    proxy_set_header Accept-Encoding "";

    # Rewrite Set-Cookie paths from /CMS to /_CMS
    proxy_cookie_path /CMS /_CMS;

    proxy_redirect     off;
    proxy_ssl_server_name on;
    proxy_ssl_session_reuse off;
    proxy_ssl_verify off;

    proxy_set_header Host $upstreamCmsDomainName:443;
    proxy_set_header X-Forwarded-For $remote_addr;

    rewrite ^/_CMS(.*)$ /CMS$1 break;
    proxy_pass $proxyDestination;
}

# ---------------------------------------------------------------------------
# CMS menu bar JS — task list link injection
# Mirrors: location ~ ^/CMS\..*/Noexpiry/Toolbar/uainMenuBar.js
# ---------------------------------------------------------------------------

location = /_CMS.24.0.01/Noexpiry/Toolbar/uainMenuBar.js {
    access_log  /dev/stdout cms_log;
    limit_req zone=cmsproxy burst=${CMS_RATE_LIMIT_QUEUE};
    add_header 'x-limit-req-status' $limit_req_status always;

    # Determine proxy location and CMS domain
    js_set $proxyDestination cmsenv.proxyDestinationCorsham;
    js_set $upstreamCmsDomainName cmsenv.upstreamCmsDomainName;

    # App launch buttons
    js_body_filter cmsenv.cmsMenuBarFilters;

    sub_filter_types *;
    sub_filter_once off;
    sub_filter https:// ${WEBSITE_SCHEME}://;

    # Add Work Management Task List launch button next to P button
    sub_filter 'var sMenuBarRight' 'sMenuBarLeft += \'<td class="menu"><img alt="Launch Task List" border="0" class="clickable" onclick="openTaskList()" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAACXBIWXMAAAsSAAALEgHS3X78AAACg0lEQVRIic2Wzys0cRzHX9+1MxO1HKbIr3a0pbF+bBFNyoGbOOCgHDZOwsHJwcW/4KA4yEVydHBBbiIZcZPnuTlwoZU2dkntfp7Dk83+GE/U1POuz2E+33p95j3vme98VSRsCT4qCHD1+5cv8Da7hYAv5E/6PwY8PT2RzWb9GXB6eopt2+zv7/9oQLCwkUwm2dvbY3x8HNd1GR0dpbu7m4GBAZaWljg6OvKEhcNhNjc3CQQ+3XckbMnr62uujo+PJRgMyvDwsFRWVkpvb6/c399LOp2W/v5+MQzDsxoaGuTl5SXHioQtUZGwJZ9fUxFha2uLubk5HMdhZ2eHqqoqAN7f30mn054ODMOgvLw8d91mtxQ/IqUU8Xic5uZmWltbCYVCuTVd19F13XNAKZUMWSmF4ziEQiESiQQjIyNcXFx8C/yhIgfZbJaHhwdqamp4fHxkaGiIRCKBaZocHBxwdnbmCWtqamJycjK/WRjy4eGhaJomKysr0tXVJaZpyvn5uaRSKbFtWwDP0jRNnp+f80IucuA4DmNjY8zPz2OaJru7u7S3twOwvb3N9fW1p4O6ujqCwXxk0QBN01hfX8e2bQYHB4nFYrm1aDRKNBr1HFBKJUPWdZ3FxUVisRiZTIbV1VXu7u6+Bf5QkQP4+y0opchkMiwsLLCxsUFnZyeGYXBzc+MJq66uxrKs/GZhyK7rSk9Pj1xeXsrMzIwEAgFZW1uTVColHR0dX4ZcUVHx75Bra2tJJpP09fXx9vbG8vIyU1NTAMzOzuK6rqeD+vp6ysrK8npFWwXA7e0tExMTxONxpqenUUp5Qr9Sya0CoLGxkZOTkx9BC+X7H035fapQIr7y+QMKpjOoViG+vQAAAABJRU5ErkJggg=="></td>\';\n\tvar sMenuBarRight';
    sub_filter 'function openPolaris() {' 'function openTaskList() { var win = window.open("/task-list"); if(win != null) { win.focus(); } }\n\nfunction openPolaris() {';

    # Rewrite internal CMS paths to the /_CMS prefix
    sub_filter '/CMS.24.0.01/' '/_CMS.24.0.01/';

    # Disable gzip so sub_filter can inspect the body
    proxy_set_header Accept-Encoding "";

    # Rewrite Set-Cookie paths from /CMS to /_CMS
    proxy_cookie_path /CMS /_CMS;

    proxy_redirect     off;
    proxy_ssl_server_name on;
    proxy_ssl_session_reuse off;
    proxy_ssl_verify off;

    proxy_set_header Host $upstreamCmsDomainName:443;
    proxy_set_header X-Forwarded-For $remote_addr;

    rewrite ^/_CMS(.*)$ /CMS$1 break;
    proxy_pass $proxyDestination;
}

# ---------------------------------------------------------------------------
# Case detail tabs — polaris-script.js injection
# Mirrors: location ~ ^/CMS\..*/Case/uacdCDTabs.aspx
# ---------------------------------------------------------------------------

location = /_CMS.24.0.01/Case/uacdCDTabs.aspx {
    access_log  /dev/stdout cms_log;
    limit_req zone=cmsproxy burst=${CMS_RATE_LIMIT_QUEUE};
    add_header 'x-limit-req-status' $limit_req_status always;

    # Determine proxy location and CMS domain
    js_set $proxyDestination cmsenv.proxyDestinationCorsham;
    js_set $upstreamCmsDomainName cmsenv.upstreamCmsDomainName;

    # Replace CMS domain names in response body
    js_body_filter cmsenv.replaceCmsDomains;

    sub_filter_types *;
    sub_filter_once off;
    sub_filter https:// ${WEBSITE_SCHEME}://;

    sub_filter '</html>' '<script src="/polaris-script.js"></script></html>';

    # Rewrite internal CMS paths to the /_CMS prefix
    sub_filter '/CMS.24.0.01/' '/_CMS.24.0.01/';

    # Disable gzip so sub_filter can inspect the body
    proxy_set_header Accept-Encoding "";

    # Rewrite Set-Cookie paths from /CMS to /_CMS
    proxy_cookie_path /CMS /_CMS;

    proxy_redirect     off;
    proxy_ssl_server_name on;
    proxy_ssl_session_reuse off;
    proxy_ssl_verify off;

    proxy_set_header Host $upstreamCmsDomainName:443;
    proxy_set_header X-Forwarded-For $remote_addr;

    rewrite ^/_CMS(.*)$ /CMS$1 break;
    proxy_pass $proxyDestination;
}

# ---------------------------------------------------------------------------
# Catch-all — everything else under /_CMS
# Mirrors: location ~ ^/CMS.*
# Must appear after the more specific /_CMS locations above.
# ---------------------------------------------------------------------------

location /_CMS {
    client_max_body_size 0;
    access_log  /dev/stdout cms_log;
    limit_req zone=cmsproxy burst=${CMS_RATE_LIMIT_QUEUE};
    add_header 'x-limit-req-status' $limit_req_status always;

    # IE Mode Desired
    if ( $ieaction = 'nonie+nonconfigurable+') {
      return 402 'requires Internet Explorer mode';
    }
    if ( $ieaction = 'nonie+configurable+') {
      add_header X-InternetExplorerMode 1;
      return 302 "${WEBSITE_SCHEME}://${host}${request_uri}";
    }

    # Determine proxy location and CMS domain
    js_set $proxyDestination cmsenv.proxyDestinationCorsham;
    js_set $upstreamCmsDomainName cmsenv.upstreamCmsDomainName;

    js_set $upstreamCmsModernDomainName cmsenv.upstreamCmsModernDomainName;
    js_set $upstreamCmsServicesDomainName cmsenv.upstreamCmsServicesDomainName;

    sub_filter_types *;
    sub_filter_once off;
    sub_filter https:// ${WEBSITE_SCHEME}://;
    sub_filter '</html>' '<!-- General rule applied --></html>';

    sub_filter $upstreamCmsModernDomainName $host;
    sub_filter $upstreamCmsServicesDomainName $host;
    sub_filter $upstreamCmsDomainName $host;

    # Rewrite internal CMS paths to the /_CMS prefix
    sub_filter '/CMS.24.0.01/' '/_CMS.24.0.01/';

    # Disable gzip so sub_filter can inspect the body
    proxy_set_header Accept-Encoding "";

    # Rewrite Set-Cookie paths from /CMS to /_CMS
    proxy_cookie_path /CMS /_CMS;

    proxy_redirect ~^(http|https)://[^/]+(/.*)?$ ${WEBSITE_SCHEME}://$host$2;
    proxy_ssl_server_name on;
    proxy_ssl_session_reuse off;
    proxy_ssl_verify off;

    proxy_set_header Host $upstreamCmsDomainName:443;
    proxy_set_header X-Forwarded-For $remote_addr;

    # Strip the leading underscore: /_CMS... -> /CMS...
    rewrite ^/_CMS(.*)$ /CMS$1 break;
    proxy_pass $proxyDestination;
}
