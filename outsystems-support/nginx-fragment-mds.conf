location /api/global-components/ {
    # CORS stuff to keep calls from OS happy
    # if ($request_method = OPTIONS) {
    #     add_header Access-Control-Allow-Origin $http_origin always;
    #     add_header Access-Control-Allow-Credentials true always;
    #     add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    #     add_header Access-Control-Allow-Headers "Authorization, Content-Type, Correlation-Id, X-Application, Cms-Auth-Values" always;
    #     add_header Vary Origin always;
    #     return 204;
    # }

    # Lift CMS-Auth-Values from headers if not found in cookies
    set $modified_cookie $http_cookie;
    if ($cookie_CMS-Auth-Values = "") {
        set $modified_cookie "CMS-Auth-Values=$http_cms_auth_values; $http_cookie";
    }
    proxy_set_header Cookie $modified_cookie;

    # # Prevent upstream CORS checks blocking us
    # proxy_set_header Origin "${WEBSITE_SCHEME}://${host}";

    set $upstream_mds_url "https://foo.azurewebsites.net/api/";
    proxy_set_header x-functions-key ${WM_MDS_KEY};
    proxy_pass $upstream_mds_url;

    # # Prevent browser complaining about CORS at the end of the process
    # proxy_hide_header Access-Control-Allow-Origin;
    # add_header Access-Control-Allow-Origin $http_origin always;

    # # Diagnostic headers 
    # add_header X-Original-URI $request_uri always;
    # add_header X-Transformed-URI $uri always;
}

### Generation 2

location ~ ^/api/global-components/(.*)$ {
    # CORS stuff to keep calls from OS happy
    if ($request_method = OPTIONS) {
        add_header Access-Control-Allow-Origin $http_origin always;
        add_header Access-Control-Allow-Credentials true always;
        add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
        add_header Access-Control-Allow-Headers "Authorization, Content-Type, Correlation-Id, X-Application, Cms-Auth-Values" always;
        add_header Vary Origin always;
        return 204;
    }
    
    # Prevent upstream CORS checks blocking us
    proxy_set_header Origin "${WEBSITE_SCHEME}://${host}";

    set $upstream_mds_url "https://foo.azurewebsites.net/api/";
    
    # Debug headers
    add_header X-Debug-Original-URI $request_uri always;
    add_header X-Debug-Proxied-To "$upstream_mds_url$1" always;

    proxy_set_header x-functions-key ${WM_MDS_KEY};
    proxy_pass $upstream_mds_url$1;  # Appends only the captured part

    # Rewrite URLs in responses
    sub_filter_once off;  # Replace all occurrences, not just the first
    sub_filter_types application/json text/html;  # Apply to JSON and HTML responses
    
    # Replace the upstream URL with your proxy URL
    sub_filter 'https://foo.azurewebsites.net/api' 'https://$host/api/global-components';
    
    # If the swagger.json contains just the path without domain
    sub_filter '"/api/' '"/api/global-components/';
    
    # Fix the swagger base URL if it appears in the response
    sub_filter '"url": "/api"' '"url": "/api/global-components"';

    # Prevent browser complaining about CORS at the end of the process
    proxy_hide_header Access-Control-Allow-Origin;
    add_header Access-Control-Allow-Origin $http_origin always;
}

### Generation 3

# Handle swagger.json specifically
location ~ ^/api/global-components/(.*swagger(\.json|/ui).*)$ {
    set $upstream_mds_url "https://foo.azurewebsites.net/api/";
    
    proxy_set_header x-functions-key ${WM_MDS_KEY};
    proxy_set_header Accept-Encoding "";  # Disable compression for sub_filter
    proxy_pass $upstream_mds_url$1;
    
    # URL rewriting only for swagger.json
    sub_filter_once off;
    sub_filter_types application/json;
    sub_filter 'https://foo.azurewebsites.net/api' 'https://$host/api/global-components';
    sub_filter '"/api/' '"/api/global-components/';
    
    add_header Access-Control-Allow-Origin $http_origin always;
}

# Handle everything else
location ~ ^/api/global-components/(.*)$ {
    set $upstream_mds_url "https://foo.azurewebsites.net/api/";
    
    # Debug headers
    add_header X-Debug-Original-URI $request_uri always;
    add_header X-Debug-Proxied-To "$upstream_mds_url$1" always;

    set $cms_auth_value $http_cms_auth_values;
    if ($cms_auth_value = "") {
        # cookie names are case sensitive. CWA UI uses CMS_Auth_Values
        set $cms_auth_value $cookie_CMS_Auth_Values;
    }

    proxy_set_header x-functions-key ${WM_MDS_KEY};
    proxy_set_header cms-auth-values $cms_auth_value;
    proxy_set_header Authorization "";  # Strip Authorization header, upstream does not want it
    proxy_pass $upstream_mds_url$1;
    
    add_header Access-Control-Allow-Origin $http_origin always;
}